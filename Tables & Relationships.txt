ğŸ— Tables & Relationships


ğŸ‘¤ users (Handled by Supabase Auth)

column	type	notes
id	uuid (PK)	from Supabase
email	text	unique
role	text	customer / admin
created_at	timestamp	

ğŸ‘• products

column		type
id		uuid (PK)
name		text
brand		text
price		numeric
size		text
condition	text
description	text
status	available / reserved / sold
created_at	timestamp

Relationship:

products (1) â€”â€” (many) order_items

ğŸ›’ orders

column			type
id			uuid (PK)
user_id			uuid (FK â†’ users.id)
total_amount		numeric
payment_method		text
payment_status		pending / paid / failed
delivery_method		courier / pickup
delivery_status		pending / in_transit / delivered
courier			text
tracking_number		text
shipping_address	text
created_at		timestamp

Relationship:

users (1) â€”â€” (many) orders
orders (1) â€”â€” (many) order_items

ğŸ“¦ order_items

column		type
id		uuid (PK)
order_id	uuid (FK â†’ orders.id)
product_id	uuid (FK â†’ products.id)
price		numeric

ğŸ“¤ payments (optional but recommended for audit)
column		type
id		uuid
order_id	uuid
proof_url	text
verified_by	uuid (admin)
verified_at	timestamp

ğŸ§  Key Constraints (Important sa Ukay)

1ï¸âƒ£ product.status must be updated inside transaction
2ï¸âƒ£ Only one product per order_item for ukay
3ï¸âƒ£ Prevent double checkout (transaction required)

//SQL protection example:

BEGIN;

SELECT status FROM products WHERE id = 'uuid' FOR UPDATE;

-- if status != available â†’ rollback

UPDATE products SET status = 'reserved'
WHERE id = 'uuid';

INSERT INTO orders (...);

COMMIT;//

ğŸ” SECURE ARCHITECTURE PLAN (Anti-Hack / Anti-Fraud)
ğŸ§± 1ï¸âƒ£ Authentication Security

Use Supabase Auth OR JWT + Refresh Token strategy.

Recommendations:

âœ” Password hashed (bcrypt)
âœ” Access token short life (15m)
âœ” Refresh token rotation
âœ” HttpOnly cookies only
âœ” Email verification required

ğŸ”’ 2ï¸âƒ£ Row Level Security (Supabase)

Enable RLS.

Example:

Customer can only see their orders:

//CREATE POLICY "Users can view own orders"
ON orders
FOR SELECT
USING (auth.uid() = user_id);

Admin access:

CREATE POLICY "Admin full access"
ON orders
FOR ALL
USING (
  EXISTS (
    SELECT 1 FROM users
    WHERE users.id = auth.uid()
    AND users.role = 'admin'
  )
);//

ğŸ›¡ 3ï¸âƒ£ API Security (Express Layer)

âœ” Rate limiting (prevent spam)
âœ” Helmet middleware
âœ” CORS strict origin
âœ” Input validation (Zod / Joi)
âœ” Sanitize inputs
âœ” Never expose service_role key to frontend

Example:
//
app.use(rateLimit({
  windowMs: 15 * 60 * 1000,
  max: 100
}))
//

ğŸ’³ 4ï¸âƒ£ Payment Fraud Prevention

For PH manual payments:

âœ” Require screenshot proof upload
âœ” Verify reference number
âœ” Store proof image in Supabase Storage
âœ” Log admin verifier ID
âœ” Prevent status change without admin role

Never allow frontend to directly update:

payment_status = 'paid'

Only backend with admin auth.

ğŸš¨ 5ï¸âƒ£ Anti Double Purchase (Critical sa Ukay)

Use:

âœ” PostgreSQL transaction
âœ” â€œFOR UPDATEâ€ locking
âœ” Status check before insert

Without this, dalawang user makakabili ng isang item.

ğŸ“¦ 6ï¸âƒ£ Delivery Security

âœ” Tracking number cannot be edited after delivery
âœ” Only admin can update delivery_status
âœ” Log delivery status changes

Add audit log table:

audit_logs
- id
- action
- user_id
- order_id
- timestamp

ğŸŒ 7ï¸âƒ£ Infrastructure Security

Frontend â†’ Vercel
Backend â†’ Render / Railway
Database â†’ Supabase

Checklist:

âœ” HTTPS enforced
âœ” Environment variables protected
âœ” Enable Supabase RLS
âœ” Use .env in backend only
âœ” Separate dev & prod database

ğŸ”¥ 8ï¸âƒ£ Production Security Upgrade (Later Stage)

Phase 2:

âœ” Cloudflare firewall
âœ” WAF rules
âœ” Auto backup database daily
âœ” Monitoring (Sentry)
âœ” Admin 2FA


ğŸ— Final Secure Architecture
User
 â†“
Next.js Frontend
 â†“ (JWT / Cookie)
Express API
 â†“
Supabase (PostgreSQL + RLS)
 â†“
Storage (Proof images)
 â†“
Courier (LBC/J&T etc.)


ğŸ¯ What Makes This â€œProduction-Readyâ€

âœ” Proper relational schema
âœ” Transaction-based product locking
âœ” Secure authentication
âœ” Role-based access control
âœ” Audit logging
âœ” Delivery state control
âœ” Scalable PostgreSQL structure
âœ” Ready for nationwide PH shipping